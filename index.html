<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¡×š ×ª×¨×•××•×ª - ×§××¤×™×™×Ÿ</title>
    
    <!-- ×¡×§×¨×™×¤×˜ ×œ×× ×™××¦×™×™×ª ×§×•× ×¤×˜×™ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap');

        :root {
            /* ×¤×œ×˜×ª ×¦×‘×¢×™× ×—×“×©×” - ×™×•×§×¨×ª×™ (×–×”×‘ ×•×—×•×) */
            --bg-color: #0d0704; /* ×—×•× ×›×”×” ×××•×“/×©×—×•×¨ ×¢××•×§ */
            --box-bg: rgba(45, 25, 15, 0.45); /* ×—×•× ×©×§×•×£ ×–×›×•×›×™×ª×™ */
            --glass-border: rgba(226, 194, 117, 0.15); /* ××¡×’×¨×ª ×–×”×‘ ×¢×“×™× ×” */
            --gold: #d4af37;
            --gold-light: #fef0d5;
            --silver: #e5e7eb;
            --bronze: #d97736;
            --text-main: #fdf8f5; /* ×œ×‘×Ÿ ×—××™× ××¢×˜ */
            --text-muted: #bdaea6;
            --border-radius: 1.5vw;
            --gap: 1vw;
            
            /* ×–×•×”×¨×™× ×•× ×™××•×Ÿ ×‘×–×”×‘ ×‘××§×•× ×™×¨×•×§ */
            --glow-money: 0 0 15px rgba(253, 224, 71, 0.5);
            --glow-gold: 0 0 20px rgba(212, 175, 55, 0.3);
            --money-color: #fde047; /* ×–×”×‘ ××•××¨ ×œ×›×¡×£ */
        }

        body {
            margin: 0;
            padding: 1vw;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 15% 20%, rgba(70, 35, 15, 0.4) 0%, transparent 40%),
                radial-gradient(circle at 85% 80%, rgba(212, 175, 55, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 100%, rgba(35, 15, 5, 0.8) 0%, transparent 60%);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            gap: 1vh;
            height: 100vh;
            width: 100vw;
            box-sizing: border-box;
            overflow: hidden;
            font-family: 'Heebo', sans-serif;
            backdrop-filter: blur(50px);
        }

        /* --- ×›×•×ª×¨×ª ×¡×”"×› × ×ª×¨× ×•×”×ª×§×“××•×ª --- */
        #campaign-header {
            flex: 0 0 11vh;
            width: 100%; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(30, 15, 8, 0.65); /* ×—×•× ×¢×©×™×¨ ×•×›×”×” */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            padding: 0.5vh 2vw;
            border: 1px solid var(--glass-border); 
            border-bottom: 3px solid var(--gold); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5), inset 0 -4px 15px rgba(226, 194, 117, 0.1);
            line-height: 1.1;
            box-sizing: border-box;
            position: relative; 
            z-index: 10;
        }

        /* ×¢×™×¦×•×‘ ×”×œ×•×’×• - ××¨×—×£ ×—×•×¤×©×™ ×‘×¦×“×“×™×, ××•×’×“×œ ×•×™×•×¨×“ ×œ××˜×” */
        .campaign-logo {
            position: absolute;
            top: -1.5vh; 
            height: 26vh; 
            max-width: 25vw;
            object-fit: contain;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.8)) drop-shadow(0 0 25px rgba(226, 194, 117, 0.5)); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 101; 
        }

        .logo-right {
            right: -1vw; 
        }
        .logo-right:hover {
            transform: scale(1.05) rotate(-2deg); 
        }

        .logo-left {
            left: -1vw; 
        }
        .logo-left:hover {
            transform: scale(1.05) rotate(2deg); 
        }

        .header-top { display: flex; align-items: baseline; gap: 1vw; }
        .header-title { font-size: 3vh; color: var(--gold-light); font-weight: 700; letter-spacing: 1px; }
        .header-amount { 
            font-size: 5.5vh; 
            font-weight: 900; 
            color: var(--money-color); 
            text-shadow: var(--glow-money); 
            letter-spacing: 2px;
        }
        
        .header-progress { font-size: 1.8vh; color: var(--text-muted); margin-top: 0.5vh; font-weight: bold; letter-spacing: 1px;}
        .progress-bar-container { 
            width: 100%; max-width: 40vw; height: 0.8vh; 
            background: rgba(0,0,0,0.6); border-radius: 1vw; 
            margin-top: 0.8vh; overflow: hidden; 
            border: 1px solid rgba(226, 194, 117, 0.2); 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .progress-bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #a16207, #eab308, #fef08a); /* ×’×¨×“×™×× ×˜ ××•×–×”×‘ ×—×“×© */
            width: 0%; transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: var(--glow-money);
        }

        /* --- ×¤×•×“×™×•× (×©×œ×•×©×ª ×”×’×“×•×œ×™×) --- */
        #podium-section {
            flex: 0 0 25vh;
            display: flex;
            gap: 1.5vw;
            justify-content: center;
            align-items: flex-end;
            box-sizing: border-box;
            padding-bottom: 0.5vh;
        }

        .podium-box {
            border-radius: 1.5vw; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
            position: relative;
            overflow: hidden;
            padding: 1vh 1vw; 
            box-sizing: border-box;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            margin-bottom: 0.5vh;
        }
        
        .podium-box:hover {
            transform: translateY(-5px);
        }

        .podium-box::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%);
            transform: rotate(45deg);
            animation: shine 6s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            20%, 100% { transform: translateX(100%) rotate(45deg); }
        }

        .podium-title { 
            font-size: 1.5vh; font-weight: bold; 
            background: rgba(0,0,0,0.5); padding: 0.4vh 1.2vw; 
            border-radius: 2vw; margin-bottom: 1vh;
            border: 1px solid rgba(226, 194, 117, 0.2);
        }
        .podium-name { 
            font-size: 2.6vh; 
            font-weight: 900; 
            line-height: 1.2; 
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            text-shadow: 0 2px 4px rgba(0,0,0,0.6);
        }
        .podium-vaad { font-size: 1.6vh; opacity: 0.7; margin-top: 0.5vh; font-weight: 400;}
        .podium-amount { font-size: 3.5vh; font-weight: 900; margin-top: auto; }

        .podium-1 { 
            width: 26vw; height: 100%; 
            background: linear-gradient(145deg, rgba(226, 194, 117, 0.15) 0%, rgba(35, 15, 5, 0.8) 100%);
            border: 3px solid var(--gold); 
            box-shadow: 0 10px 30px rgba(226, 194, 117, 0.15), inset 0 0 20px rgba(226, 194, 117, 0.05); 
            z-index: 3; 
        }
        .podium-1 .podium-amount { color: var(--gold-light); font-size: 4.2vh; text-shadow: var(--glow-gold); }
        .podium-1 .podium-name { font-size: 3.2vh; color: #fff;}

        .podium-2 { 
            width: 21vw; height: 85%; 
            background: linear-gradient(145deg, rgba(209, 213, 219, 0.15) 0%, rgba(35, 15, 5, 0.8) 100%);
            border: 3px solid var(--silver); 
            box-shadow: 0 5px 20px rgba(209, 213, 219, 0.1);
            z-index: 2; 
        }
        .podium-2 .podium-amount { color: var(--silver); font-size: 3.2vh; }
        .podium-2 .podium-name { font-size: 2.3vh; }

        .podium-3 { 
            width: 21vw; height: 76%; 
            background: linear-gradient(145deg, rgba(205, 127, 50, 0.15) 0%, rgba(35, 15, 5, 0.8) 100%);
            border: 3px solid var(--bronze); 
            box-shadow: 0 5px 20px rgba(205, 127, 50, 0.1);
            z-index: 1; 
        }
        .podium-3 .podium-amount { color: var(--bronze); font-size: 3.2vh; }
        .podium-3 .podium-name { font-size: 2.3vh; }


        /* --- ×—×œ×§ ×××¦×¢×™ (××¨×›×–×™ ×•×¦×“ ×™××™×Ÿ) --- */
        #middle-section {
            flex: 1 1 0; 
            min-height: 0; 
            display: flex;
            gap: var(--gap);
        }

        /* ×™××™×Ÿ - ×•×¢×“×™× */
        #sidebar-right {
            flex: 0 0 15vw; 
            display: flex;
            flex-direction: column;
            gap: 1vh;
        }

        .vaad-box {
            flex: 1;
            background: var(--box-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            border-right: 4px solid var(--gold);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            box-sizing: border-box;
            overflow: hidden;
            transition: all 0.5s ease;
            backdrop-filter: blur(8px);
        }

        .vaad-name { font-size: 2vh; font-weight: 700; color: var(--gold-light); letter-spacing: 0.5px;}
        .vaad-amount { font-size: 3.2vh; font-weight: 900; color: var(--gold); letter-spacing: 1px;}

        /* ×©×××œ - ×‘×—×•×¨×™× × ×’×œ×œ×™× */
        #main-left {
            flex: 1;
            background: rgba(25, 12, 5, 0.4); /* ×¨×§×¢ ×—×•× ×¢×“×™×Ÿ ×•×›×”×” */
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            padding: 1vw;
            box-sizing: border-box;
            border: 1px solid var(--glass-border);
            box-shadow: inset 0 0 4vw rgba(0,0,0,0.5);
        }

        .scrolling-wrapper {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            grid-auto-flow: column;
            grid-auto-columns: calc(25% - 0.75vw); 
            gap: 1vw;
            height: 100%;
        }

        .student-box {
            background: rgba(255,255,255,0.03);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0.5vh 0.5vw;
            position: relative;
            overflow: hidden;
            transition: background 0.3s, border-color 0.3s;
        }
        
        .student-box:hover {
            background: rgba(226, 194, 117, 0.08);
            border-color: rgba(226, 194, 117, 0.4);
        }

        .student-name { 
            font-size: 2.2vh; 
            font-weight: 700; 
            line-height: 1.2; 
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-word;
        }
        .student-vaad { font-size: 1.5vh; color: var(--text-muted); margin: 0.5vh 0; }
        .student-amount { font-size: 2.8vh; font-weight: 900; color: var(--gold); }

        /* --- ×©×•×¨×” ×ª×—×ª×•× ×” --- */
        #bottom-section {
            flex: 0 0 12vh;
            display: flex;
            gap: var(--gap);
            position: relative;
            box-sizing: border-box;
            margin-top: 1vh;
            background: rgba(0,0,0,0.3);
            padding: 1vh 1vw;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
        }

        .bottom-title {
            position: absolute;
            top: -2.5vh;
            right: 1.5vw;
            font-size: 1.6vh;
            color: var(--gold-light);
            font-weight: bold;
            background: linear-gradient(135deg, #3a1c0a, #0a0502); /* ×—×•× ×•×–×”×‘ */
            padding: 0.4vh 1.5vw;
            border-radius: 1vw;
            border: 1px solid rgba(226, 194, 117, 0.3);
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
            letter-spacing: 1px;
        }

        .bottom-box {
            flex: 1;
            background: linear-gradient(180deg, rgba(226,194,117,0.06) 0%, rgba(226,194,117,0.01) 100%);
            border-radius: 1vw;
            border: 1px solid rgba(226,194,117,0.08);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            box-sizing: border-box;
            overflow: hidden;
            padding: 0.5vh 0.5vw;
        }

        .bottom-box.new-item {
            animation: slideInLeft 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .empty-state {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(226, 194, 117, 0.3);
            font-size: 3vh;
            border-radius: var(--border-radius);
            font-weight: 300;
            letter-spacing: 1px;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-5vw) scale(0.9); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        /* --- ×”×ª×¨××” ××ª×¤×¨×¦×ª (Overlay) --- */
        #alert-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: transparent;
            backdrop-filter: blur(0px);
            -webkit-backdrop-filter: blur(0px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* ×× ×™××¦×™×™×ª ×”×‘×”×•×‘ ×œ××¡×š ×”×¨×§×¢ ×©×œ ×”×¤×•×¤××¤ */
        @keyframes overlayFlash {
            0% { background: rgba(226, 194, 117, 0.2); backdrop-filter: blur(5px); }
            100% { background: rgba(20, 10, 5, 0.85); backdrop-filter: blur(20px); } /* ××•×—×©×š ×œ×—×•× ×¢××•×§ */
        }

        #alert-overlay.active {
            opacity: 1;
            animation: overlayFlash 0.5s ease-out forwards;
        }

        #alert-card {
            background: radial-gradient(circle at top right, #3a1a05, #0a0502);
            border: 3px solid var(--gold);
            border-radius: 3vw;
            padding: 6vw;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9), inset 0 0 60px rgba(226, 194, 117, 0.2);
            position: relative; 
            transform: scale(0);
            opacity: 0;
        }

        /* ×× ×™××¦×™×™×ª ×§×¤×™×¦×” ×•×”×‘×”×•×‘ ×™×•×§×¨×ª×™ ×œ×¤×•×¤××¤ ×¢×¦××• - ××•×–×”×‘ */
        @keyframes popupEntrance {
            0% { transform: scale(0.3); opacity: 0; box-shadow: 0 0 100px #fff, inset 0 0 100px #fff; filter: brightness(3); }
            40% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 80px rgba(234, 179, 8, 0.8); filter: brightness(1.5); } /* ×”×‘×”×•×‘ ×‘×–×”×‘ */
            70% { transform: scale(0.95); filter: brightness(1.1); }
            100% { transform: scale(1); filter: brightness(1); opacity: 1; }
        }

        #alert-overlay.active #alert-card {
            animation: popupEntrance 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        #alert-card::before {
            content: 'â­';
            font-size: 4vw;
            position: absolute;
            top: -2vw;
            left: 50%;
            transform: translateX(-50%);
            animation: pulseStar 2s infinite;
        }
        
        @keyframes pulseStar {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 0.7; }
        }

        .alert-title { font-size: 3.5vw; color: var(--gold-light); margin-bottom: 1.5vw; letter-spacing: 2px; font-weight: 700;}
        .alert-name { font-size: 7vw; font-weight: 900; margin: 1vw 0; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.6); }
        .alert-vaad { font-size: 2.5vw; color: var(--gold-light); background: rgba(226, 194, 117, 0.15); display: inline-block; padding: 0.5vw 2vw; border-radius: 50px; border: 1px solid rgba(226, 194, 117, 0.3);}
        .alert-amount { font-size: 9vw; font-weight: 900; color: var(--money-color); margin-top: 2vw; text-shadow: var(--glow-money); }

        .shrinking {
            animation: none !important; 
            position: absolute !important;
            margin: 0 !important;
            padding: 0.5vh !important;
            border-width: 1px !important;
            border-radius: 1vw !important;
            background: linear-gradient(180deg, rgba(226,194,117,0.06) 0%, rgba(226,194,117,0.01) 100%) !important;
            box-shadow: none !important;
            transform: scale(1) !important;
            opacity: 1 !important;
        }
        .shrinking::before { display: none !important; }
        .shrinking .alert-title { display: none; }
        .shrinking .alert-name { font-size: 1.8vh !important; margin: 0 !important; line-height: 1.2 !important; text-shadow: none !important; }
        .shrinking .alert-vaad { font-size: 1.2vh !important; background: transparent !important; padding: 0 !important; border:none !important;}
        .shrinking .alert-amount { font-size: 2.2vh !important; margin: 0 !important; color: var(--gold) !important; text-shadow: none !important;}

    </style>
</head>
<body>

    <div id="campaign-header">
        <!-- ×”×œ×•×’×•××™× ×”×•×˜××¢×• ×‘×©× ×™ ×”×¦×“×“×™× -->
        <img src="https://noam.page.gd/tat/LOGO2.png" alt="×œ×•×’×• ×”×§××¤×™×™×Ÿ" class="campaign-logo logo-right">
        <img src="https://noam.page.gd/tat/LOGO2.png" alt="×œ×•×’×• ×”×§××¤×™×™×Ÿ" class="campaign-logo logo-left">
        
        <div class="header-top">
            <div class="header-title">×¡×”"×› × ×ª×¨×:</div>
            <div class="header-amount" id="campaign-total">â‚ª0</div>
        </div>
        <div class="header-progress" id="campaign-progress-text">×××ª×™×Ÿ ×œ× ×ª×•× ×™×...</div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="campaign-progress-bar"></div>
        </div>
    </div>

    <div id="podium-section">
        <div class="empty-state" style="width:100%; height:100%; border:none; background:transparent;">×××ª×™× ×™× ×œ× ×ª×•× ×™ ×ª×¨×•××•×ª...</div>
    </div>

    <div id="middle-section">
        <div id="main-left">
            <div class="scrolling-wrapper" id="scrolling-grid">
                <div style="width:100%; height:100%; display:flex; justify-content:center; align-items:center; color:rgba(226, 194, 117, 0.2); font-size:3vh; font-weight:300;">××—×¤×© × ×ª×•× ×™× ×‘×©×¨×ª...</div>
            </div>
        </div>
        <div id="sidebar-right"></div>
    </div>

    <div id="bottom-section">
        <div class="bottom-title" id="bottom-title">×ª×¨×•××•×ª ××—×¨×•× ×•×ª</div>
    </div>

    <div id="alert-overlay">
        <div id="alert-card">
            <div class="alert-title">×ª×¨×•××” ×—×“×©×”!</div>
            <div class="alert-name" id="alert-name">×™×©×¨××œ ×™×©×¨××œ×™</div>
            <div class="alert-vaad" id="alert-vaad">×§×™×‘×•×¥ ×'</div>
            <div class="alert-amount" id="alert-amount">â‚ª5,000</div>
        </div>
    </div>

    <script>
        const API_URL = "https://www.matara.pro/nedarimplus/V6/MatchPlus.aspx?Action=SearchMatrim&Name=&MosadId=1000347";
        const GOAL_URL = "https://www.matara.pro/nedarimplus/V6/MatchPlus.aspx?Action=ShowGoal&MatchingId=759";
        
        let allStudents = [];
        let topNext6 = [];
        let last6 = []; 
        let knownAmounts = {}; 
        
        const GROUPS = ["×©×™×¢×•×¨ ×'", "×©×™×¢×•×¨ ×‘'", "×©×™×¢×•×¨ ×’'", "×§×™×‘×•×¥ ×'", "×§×™×‘×•×¥"];
        let groupTotals = {};

        let bottomMode = 'recent'; 
        let bottomToggleInterval;
        let alertQueue = [];
        let isAlerting = false;
        
        let isFirstSuccessfulLoad = true; 
        
        // ××©×ª× ×™ ×–×™×”×•×™ ×œ×—×’×™×’×•×ª ×§×•× ×¤×˜×™
        let previousTotalRaised = 0;
        let previousTop3Ids = [];
        let confettiInterval;
        let confettiAnimationEnd = 0; 

        const parseAmount = (val) => {
            if (val === undefined || val === null) return 0;
            if (typeof val === 'number') return val;
            const str = String(val).replace(/[^\d.]/g, ''); 
            return parseFloat(str) || 0;
        };

        const cleanText = (txt) => txt ? String(txt).replace(/['"×´×³`\s]/g, '') : '';

        const formatMoney = (amount) => {
            const num = parseFloat(amount);
            return 'â‚ª' + (isNaN(num) ? 0 : num).toLocaleString('he-IL');
        };

        // --- ×× ×’× ×•×Ÿ ×—×’×™×’×•×ª ×§×•× ×¤×˜×™ ××©×•×¤×¨ ×¢×œ ×›×œ ×”××¡×š ---
        function startConfetti(duration = 60000) {
            let newEnd = Date.now() + duration;
            if (newEnd > confettiAnimationEnd) {
                confettiAnimationEnd = newEnd;
            }
            
            if (confettiInterval) clearInterval(confettiInterval);
            
            let defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10000, colors: ['#d4af37', '#fdf0d5', '#e5e7eb', '#d97736'] }; 

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            confettiInterval = setInterval(function() {
                let timeLeft = confettiAnimationEnd - Date.now();

                if (timeLeft <= 0) {
                    confettiAnimationEnd = 0;
                    return clearInterval(confettiInterval);
                }

                let particleCount = 40;
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        function init() {
            GROUPS.forEach(g => groupTotals[g] = 0);
            renderSidebar();
            
            pollData();
            pollGoal();
            
            startBottomToggleTimer();
            setupScrolling();
        }

        // ×§×¨×™××ª × ×ª×•× ×™ ×ª×¨×•××•×ª ×•×¡×š ×”×›×œ - ×›×œ 15 ×©× ×™×•×ª
        async function pollData() {
            try { await fetchData(); } catch (e) { console.error("Data fetch error:", e); }
            setTimeout(pollData, 15000); 
        }

        async function pollGoal() {
            try { await fetchGoal(); } catch (e) { console.error("Goal fetch error:", e); }
            setTimeout(pollGoal, 15000);
        }

        async function fetchGoal() {
            try {
                const response = await fetch(GOAL_URL);
                if (!response.ok) return;
                
                let textData = await response.text();
                textData = textData.trim().replace(/^\uFEFF/, ''); 
                if (textData.endsWith(',')) textData = textData.slice(0, -1).trim();
                if (textData.startsWith('{') && !textData.endsWith('}')) textData += '}';
                
                let data = JSON.parse(textData);
                
                let totalRaised = parseAmount(data.Donated);
                let goalAmount = parseAmount(data.Goal);
                
                if (totalRaised === 0) {
                    for(let key in data) {
                        let lowerKey = String(key).toLowerCase();
                        if((lowerKey.includes('donate') || lowerKey.includes('raise') || lowerKey.includes('amount') || lowerKey.includes('sum') || lowerKey.includes('total') || lowerKey.includes('coin')) 
                           && !lowerKey.includes('target') && !lowerKey.includes('goal') && !lowerKey.includes('yaad') && !lowerKey.includes('count')) {
                            let temp = parseAmount(data[key]);
                            if(temp > totalRaised) totalRaised = temp;
                        }
                    }
                }
                
                if (goalAmount === 0) {
                    for(let key in data) {
                        let lowerKey = String(key).toLowerCase();
                        if(lowerKey.includes('goal') || lowerKey.includes('target')) {
                            let temp = parseAmount(data[key]);
                            if(temp > goalAmount) goalAmount = temp;
                        }
                    }
                }
                
                if (previousTotalRaised > 0 && totalRaised > previousTotalRaised) {
                    let prevMilestone = Math.floor(previousTotalRaised / 100000);
                    let currentMilestone = Math.floor(totalRaised / 100000);
                    if (currentMilestone > prevMilestone) {
                        startConfetti(60000); 
                    }
                }
                if (totalRaised > 0) previousTotalRaised = totalRaised;

                if (totalRaised > 0) {
                    document.getElementById('campaign-total').innerText = formatMoney(totalRaised);
                }
                
                if (goalAmount > 0) {
                    let percent = Math.floor((totalRaised / goalAmount) * 100);
                    document.getElementById('campaign-progress-text').innerText = `××ª×•×š ${formatMoney(goalAmount)} (${percent}%)`;
                    
                    let visualPercent = percent > 100 ? 100 : percent;
                    document.getElementById('campaign-progress-bar').style.width = visualPercent + '%';
                }
                
            } catch (error) {
                throw error;
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("HTTP Status " + response.status);
                
                let textData = await response.text();
                textData = textData.trim().replace(/^\uFEFF/, ''); 
                
                if (textData.endsWith(',')) {
                    textData = textData.slice(0, -1).trim();
                }
                
                if (textData.startsWith('{')) {
                    textData = `[${textData}]`; 
                }
                
                let data = JSON.parse(textData);
                
                let dataArray = [];
                if (Array.isArray(data)) {
                    if (data.length === 1 && data[0] && typeof data[0] === 'object') {
                        if (Array.isArray(data[0].Data)) dataArray = data[0].Data;
                        else if (Array.isArray(data[0].msg)) dataArray = data[0].msg;
                        else if (Array.isArray(data[0].Items)) dataArray = data[0].Items;
                        else dataArray = data; 
                    } else {
                        dataArray = data; 
                    }
                } else {
                    throw new Error("Parsed JSON is not an array");
                }
                
                processData(dataArray, isFirstSuccessfulLoad);
                isFirstSuccessfulLoad = false; 
                
            } catch (error) {
                throw error;
            }
        }

        function processData(data, isInitialLoad) {
            let newDonations = [];
            
            GROUPS.forEach(g => groupTotals[g] = 0);

            let processedStudents = data.map(item => {
                let id = item.Id || item.MatrimId || item.Name || Math.random().toString(); 
                let name = item.Name || item.FirstName + ' ' + item.LastName || "×ª×•×¨×";
                let vaad = item.GroupName || item.Vaad || item.Group || "×›×œ×œ×™";
                
                let amount = parseAmount(item.Cumule);
                
                if (amount === 0) {
                    for (let key in item) {
                        let lowerKey = String(key).toLowerCase();
                        if ((lowerKey.includes('cumul') || lowerKey.includes('amount') || lowerKey.includes('sum') || lowerKey.includes('total') || lowerKey.includes('raise') || lowerKey.includes('×¡×›×•×')) 
                            && !lowerKey.includes('target') && !lowerKey.includes('goal') && !lowerKey.includes('yaad') && !lowerKey.includes('count')) {
                            let temp = parseAmount(item[key]);
                            if (temp > amount) amount = temp;
                        }
                    }
                }

                let matchedGroup = null;
                let searchStr = cleanText(vaad) + " " + cleanText(name); 
                
                if (searchStr.includes("×©×") || searchStr.includes("×©×™×¢×•×¨×")) matchedGroup = "×©×™×¢×•×¨ ×'";
                else if (searchStr.includes("×©×‘") || searchStr.includes("×©×™×¢×•×¨×‘")) matchedGroup = "×©×™×¢×•×¨ ×‘'";
                else if (searchStr.includes("×©×’") || searchStr.includes("×©×™×¢×•×¨×’")) matchedGroup = "×©×™×¢×•×¨ ×’'";
                else if (searchStr.includes("×§×") || searchStr.includes("×§×™×‘×•×¦×")) matchedGroup = "×§×™×‘×•×¥ ×'";
                else if (searchStr.includes("×§×™×‘×•×¥") || searchStr.includes("×§×‘") || searchStr.includes("×§×’") || searchStr.includes("×§×“") || searchStr.includes("×§×”")) matchedGroup = "×§×™×‘×•×¥";

                if (matchedGroup) {
                    vaad = matchedGroup;
                    groupTotals[matchedGroup] += amount;
                }
                
                name = name.replace(/(?:\s|-)*(?:[×©×§]"[×-×”]|×©×™×¢×•×¨\s+[×-×”]'?|×§×™×‘×•×¥\s+[×-×”]'?|×§×™×‘×•×¥)\s*$/i, '').trim();

                if (!isInitialLoad) {
                    let prevAmount = knownAmounts[id] || 0;
                    if (amount > prevAmount) {
                        let diff = amount - prevAmount;
                        if (diff >= 5) {
                            newDonations.push({ id, name, vaad, amount: diff, total: amount });
                        }
                    }
                }
                
                knownAmounts[id] = amount;
                return { id, name, vaad, amount };
            });

            processedStudents = processedStudents.filter(student => student.amount > 0);

            allStudents = processedStudents;
            let sortedByAmount = [...allStudents].sort((a, b) => b.amount - a.amount);
            
            topNext6 = sortedByAmount.slice(3, 9);
            let top3 = sortedByAmount.slice(0, 3);
            let others = sortedByAmount.slice(3);
            
            let currentTop3Ids = top3.map(s => s.id);
            if (!isInitialLoad && previousTop3Ids.length > 0) {
                let newWinner = currentTop3Ids.some(id => !previousTop3Ids.includes(id));
                if (newWinner) {
                    startConfetti(60000); 
                }
            }
            previousTop3Ids = currentTop3Ids;

            if (newDonations.length > 0) {
                newDonations.forEach(don => {
                    last6.unshift(don);
                    alertQueue.push(don);
                });
                last6 = last6.slice(0, 6); 
                
                forceBottomMode('recent');
                processAlertQueue();
            }

            renderPodium(top3);
            renderSidebar();
            renderMainGrid(others); 
            
            if(!isAlerting) renderBottomRow();
        }
        
        function renderPodium(top3) {
            const podium = document.getElementById('podium-section');
            podium.innerHTML = '';
            
            if(top3.length === 0) {
                podium.innerHTML = '<div class="empty-state" style="width:100%; height:100%; border:none; background:transparent;">×××ª×™× ×™× ×œ×ª×¨×•××•×ª ×¨××©×•× ×•×ª...</div>';
                return;
            }

            const displayOrder = [top3[1], top3[0], top3[2]];
            const classes = ['podium-2', 'podium-1', 'podium-3'];
            const titles = ['ğŸ¥ˆ ××§×•× ×©× ×™', 'ğŸ‘‘ ××§×•× ×¨××©×•×Ÿ', 'ğŸ¥‰ ××§×•× ×©×œ×™×©×™'];

            displayOrder.forEach((student, index) => {
                if(!student) return;
                podium.innerHTML += `
                    <div class="podium-box ${classes[index]}">
                        <div class="podium-title">${titles[index]}</div>
                        <div class="podium-name" title="${student.name}">${student.name}</div>
                        <div class="podium-vaad">${student.vaad}</div>
                        <div class="podium-amount">${formatMoney(student.amount)}</div>
                    </div>
                `;
            });
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar-right');
            sidebar.innerHTML = '';
            
            let sortedGroups = GROUPS.map(group => {
                return {
                    name: group,
                    total: groupTotals[group] || 0
                };
            }).sort((a, b) => b.total - a.total);

            sortedGroups.forEach(groupData => {
                sidebar.innerHTML += `
                    <div class="vaad-box">
                        <div class="vaad-name">${groupData.name}</div>
                        <div class="vaad-amount">${formatMoney(groupData.total)}</div>
                    </div>
                `;
            });
        }

        function renderMainGrid(students) {
            const grid = document.getElementById('scrolling-grid');
            grid.innerHTML = '';
            
            if (students.length === 0) {
                 grid.innerHTML = '<div style="width:100%; height:100%; display:flex; justify-content:center; align-items:center; color:rgba(226, 194, 117, 0.2); font-size:3vh; font-weight:300;">××™×Ÿ ×¢×“×™×™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>';
                 return;
            }
            
            students.forEach(student => {
                grid.innerHTML += `
                    <div class="student-box">
                        <div class="student-name" title="${student.name}">${student.name}</div>
                        <div class="student-vaad">${student.vaad}</div>
                        <div class="student-amount">${formatMoney(student.amount)}</div>
                    </div>
                `;
            });

            grid.innerHTML += grid.innerHTML;
        }

        function renderBottomRow() {
            const container = document.getElementById('bottom-section');
            const title = document.getElementById('bottom-title');
            
            Array.from(container.children).forEach(child => {
                if(!child.classList.contains('bottom-title')) child.remove();
            });

            let dataToShow = bottomMode === 'recent' ? last6 : topNext6;
            title.innerText = bottomMode === 'recent' ? '×ª×¨×•××•×ª ××—×¨×•× ×•×ª' : '×”×ª×¨×•××•×ª ×”×’×‘×•×”×•×ª';

            if (dataToShow.length === 0 && bottomMode === 'recent') {
                container.innerHTML += `<div class="empty-state">×××ª×™× ×™× ×œ×ª×¨×•××•×ª ×—×“×©×•×ª...</div>`;
                return;
            }

            dataToShow.forEach((item, index) => {
                const box = document.createElement('div');
                box.className = 'bottom-box new-item';
                box.style.animationDelay = `${index * 0.1}s`; 
                
                let amountToShow = bottomMode === 'recent' ? (item.amount || item.total || 0) : (item.amount || 0);

                box.innerHTML = `
                    <div class="student-name" title="${item.name}">${item.name}</div>
                    <div class="student-vaad">${item.vaad}</div>
                    <div class="student-amount">${formatMoney(amountToShow)}</div>
                `;
                container.appendChild(box);
            });
        }

        function toggleBottomMode() {
            if (isAlerting) return; 
            bottomMode = bottomMode === 'recent' ? 'top' : 'recent';
            renderBottomRow();
        }

        function startBottomToggleTimer() {
            clearInterval(bottomToggleInterval);
            bottomToggleInterval = setInterval(toggleBottomMode, 30000);
        }

        function forceBottomMode(mode) {
            bottomMode = mode;
            renderBottomRow();
            startBottomToggleTimer(); 
        }

        async function processAlertQueue() {
            if (isAlerting || alertQueue.length === 0) return;
            
            isAlerting = true;
            const donation = alertQueue.shift();
            
            const overlay = document.getElementById('alert-overlay');
            const card = document.getElementById('alert-card');
            
            document.getElementById('alert-name').innerText = donation.name;
            document.getElementById('alert-vaad').innerText = donation.vaad;
            document.getElementById('alert-amount').innerText = formatMoney(donation.amount);
            
            card.className = '';
            card.style = '';
            
            overlay.classList.add('active');
            
            startConfetti(8000);

            await new Promise(r => setTimeout(r, 8000));

            forceBottomMode('recent');
            
            const bottomSection = document.getElementById('bottom-section');
            const dummyBox = document.createElement('div');
            dummyBox.className = 'bottom-box';
            dummyBox.style.visibility = 'hidden';
            bottomSection.insertBefore(dummyBox, bottomSection.children[1]);
            
            const dummyRect = dummyBox.getBoundingClientRect();
            const startRect = card.getBoundingClientRect();

            card.style.position = 'fixed';
            card.style.left = startRect.left + 'px';
            card.style.top = startRect.top + 'px';
            card.style.width = startRect.width + 'px';
            card.style.height = startRect.height + 'px';
            card.style.margin = '0';
            
            card.classList.add('shrinking');
            
            overlay.style.backdropFilter = 'blur(0px)';
            overlay.style.backgroundColor = 'transparent';

            setTimeout(() => {
                card.style.transition = 'all 0.8s cubic-bezier(0.25, 1, 0.5, 1)';
                card.style.left = dummyRect.left + 'px';
                card.style.top = dummyRect.top + 'px';
                card.style.width = dummyRect.width + 'px';
                card.style.height = dummyRect.height + 'px';
            }, 50);

            setTimeout(() => {
                dummyBox.remove();
                overlay.classList.remove('active');
                overlay.style = ''; 
                card.style = '';
                card.classList.remove('shrinking');
                
                isAlerting = false;
                renderBottomRow(); 
                
                processAlertQueue();
            }, 850);
        }

        function setupScrolling() {
            const grid = document.getElementById('scrolling-grid');
            let scrollPos = 0;
            const speed = 1.5; 
            
            function step() {
                if (grid.scrollWidth > grid.clientWidth) {
                    scrollPos += speed;
                    if (scrollPos > grid.scrollWidth / 2) {
                        scrollPos = 0;
                    }
                    grid.style.transform = `translateX(${scrollPos}px)`;
                } else {
                    grid.style.transform = `translateX(0px)`;
                    scrollPos = 0;
                }
                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        window.onload = init;

    </script>
</body>
</html>
